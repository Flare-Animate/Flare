project(lzotools)

if(MSVC)
	# use pre-built 2.03
	get_filename_component(LZO_PATH ${SDKROOT}/lzo/2.03 ABSOLUTE)
	link_directories(${LZO_PATH}/LZO_lib/)
	if (CMAKE_SIZEOF_VOID_P EQUAL 8) 
		set(PREFIX _64)
	endif (CMAKE_SIZEOF_VOID_P EQUAL 8)
else()
    set(LZO_PATH ${LZO_INCLUDE_DIR})
endif()

include_directories(${LZO_PATH} ${LZO_PATH}/include)
add_definitions(-DLZO_USE_ASM)

# Build lzo tools only if prebuilt libraries are available and not LFS pointer files (prevents broken LFS pointers from causing link failures)
set(LZO_LIB_PATH "${LZO_PATH}/LZO_lib/lzo2${PREFIX}.lib")
set(LZO_LIB_VALID OFF)
if(MSVC AND EXISTS "${LZO_LIB_PATH}")
    file(READ "${LZO_LIB_PATH}" _lzo_contents LIMIT 512)
    string(FIND "${_lzo_contents}" "version https://git-lfs.github.com/spec/v1" _is_lfs)
    if(_is_lfs EQUAL -1)
        set(LZO_LIB_VALID ON)
    else()
        set(LZO_LIB_VALID OFF)
    endif()
endif()

if(NOT MSVC OR LZO_LIB_VALID)
    add_executable(lzocompress  lzocompress.c)
    add_executable(lzodecompress lzodecompress.c)
    if(MSVC)
        target_link_libraries(lzocompress lzo2${PREFIX} ${LZO_LIBRARY})
        target_link_libraries(lzodecompress lzo2${PREFIX} ${LZO_LIBRARY})
    else()
        target_link_libraries(lzocompress ${LZO_LIBRARY})
        target_link_libraries(lzodecompress ${LZO_LIBRARY})
    endif()
    set(LZODRIVER_FOUND true PARENT_SCOPE)
else()
    message(WARNING "Prebuilt LZO library not found or is LFS pointer; skipping build of lzo tools (lzocompress/lzodecompress). To enable, place a valid lzo2${PREFIX}.lib in ${LZO_PATH}/LZO_lib/")
    set(LZODRIVER_FOUND false PARENT_SCOPE)
endif()
