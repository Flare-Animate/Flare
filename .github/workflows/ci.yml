name: CI - Build

on:
  push:
    branches: [ main, master, rebrand-to-flare-mass, restore-flash-9e73b8, rename-to-flare-full ]
  pull_request:
    branches: [ main, master, rename-to-flare-full ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        config: [Release, Debug]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Install Qt5 on Ubuntu
      - name: Install Qt5 (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools \
            libqt5svg5-dev libqt5opengl5-dev libqt5multimedia5 libqt5multimedia5-plugins \
            libqt5multimediawidgets5 qtmultimedia5-dev qtscript5-dev qttools5-dev-tools \
            libboost-all-dev libopencv-dev

      # Install Qt5 on macOS
      - name: Install Qt5 (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install qt@5 opencv libmypaint

      # Build libtiff on macOS
      - name: Build libtiff (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          cd thirdparty/tiff-4.0.3
          CFLAGS='-fPIC' CXXFLAGS='-fPIC' ./configure --disable-lzma
          make -j $(sysctl -n hw.ncpu)
          sudo make install

      # Install Qt5 on Windows using aqtinstall
      - name: Install Qt5 (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          python -m pip install aqtinstall
          python -m aqt install-qt windows desktop 5.15.2 win64_msvc2019_64 -O C:\Qt -m qtscript
        shell: pwsh
        
      - name: Set Qt5 Path (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          echo "Qt5_DIR=C:\Qt\5.15.2\msvc2019_64\lib\cmake\Qt5" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CMAKE_PREFIX_PATH=C:\Qt\5.15.2\msvc2019_64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh

      # Install OpenCV on Windows
      - name: Install OpenCV (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install opencv -y
        shell: pwsh
        
      # Install Boost on Windows
      - name: Install Boost (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install boost-msvc-14.3 -y
        shell: pwsh
        
      - name: Set OpenCV and Boost Paths (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          echo "OpenCV_DIR=C:\tools\opencv\build" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "BOOST_ROOT=C:\local\boost_1_87_0" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: pwsh

      - name: Configure
        run: |
          mkdir -p build || true
          cmake -S flare/sources -B build -DCMAKE_BUILD_TYPE=${{ matrix.config }} > build/cmake_configure.log 2>&1 || true
          echo "--- Begin CMake configure log ---"
          (if [ -f build/cmake_configure.log ]; then cat build/cmake_configure.log; fi)
          echo "--- End CMake configure log ---"

      - name: Build
        run: |
          cmake --build build --config ${{ matrix.config }} --parallel

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run Python tests
        run: |
          pytest tools/flash/tests -q

      - name: Archive build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.os }}-${{ matrix.config }}
          path: build/
