name: MacOS Build

on:
  push:
    paths:
      - '**/*'
      - '!appveyor.yml'
      - '!README.md'
      - '!doc/**'
      - '!**/.github/**'
      - '.github/workflows/workflow_macos.yml'
  pull_request:
    paths:
      - '**/*'
      - '!appveyor.yml'
      - '!README.md'
      - '!doc/**'
      - '!**/.github/**'
      - '.github/workflows/workflow_macos.yml'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  macOS:
    timeout-minutes: 180
    env:
      GIT_LFS_SKIP_SMUDGE: '1'
    runs-on: macos-15-intel
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 1

      - name: Clean Python symlinks
        run: |
          find /usr/local/bin -type l \( -name "python*" -o -name "pip*" -o -name "2to3*" -o -name "idle*" -o -name "pydoc*" \) \
            -exec sh -c 'file -b {} | grep -q "symbolic link to .*Python.framework" && echo "Removing {}" && rm {}' \;
          for py_version in python@3.11 python@3.12 python@3.13 python@3.14; do
            if brew list --versions $py_version >/dev/null; then
              brew unlink $py_version || true
            fi
          done
          brew link --overwrite --force python@3.14 || true

      - name: Install libraries
        run: |
          checkPkgAndInstall() {
            for pkg in "$@"; do
              if brew ls --versions "$pkg" >/dev/null; then
                echo "$pkg already installed"
              else
                brew install "$pkg"
              fi
            done
          }
          
          brew update

          checkPkgAndInstall pkg-config glew lz4 libjpeg libpng lzo boost libusb libmypaint ccache jpeg-turbo ninja opencv openjph openexr qt@5

      - name: Set up cache
        run: |
          export PATH="/usr/local/opt/ccache/libexec:$PATH"
          mkdir -p /Users/runner/.ccache
      - uses: actions/cache@v5
        with:
          path: /Users/runner/.ccache
          key: ${{ runner.os }}-${{ github.sha }}
          restore-keys: ${{ runner.os }}-

      - name: Build libtiff
        run: |
          cd thirdparty/tiff-4.0.3
          chmod +x configure
          CFLAGS='-fPIC' CXXFLAGS='-fPIC' ./configure --disable-lzma
          make -j $(sysctl -n hw.ncpu)
          make install

      - name: Build
        run: |
          export PKG_CONFIG_PATH="/usr/local/opt/jpeg-turbo/lib/pkgconfig:$PKG_CONFIG_PATH"
          cd flare
          rm -rf build
          mkdir -p build
          cd build
          set +e
          cmake -S ../sources -B . -G Ninja \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DQT_PATH=$(brew --prefix qt@5)/lib \
            -DQt5_DIR=$(brew --prefix qt@5)/lib/cmake/Qt5 \
            -DCMAKE_PREFIX_PATH=$(brew --prefix qt@5)/lib/cmake/Qt5 \
            -DWITH_TRANSLATION=OFF \
            -DWITH_SYSTEM_LZO=ON \
            -DWITH_LZODRIVER=OFF > cmake_configure.log 2>&1
          rc=$?
          set -e
          echo "--- Begin CMake configure log ---"
          if [ -f cmake_configure.log ]; then cat cmake_configure.log; fi
          echo "--- End CMake configure log ---"
          if [ $rc -ne 0 ]; then
            echo "CMake configure failed with exit code $rc"
            exit $rc
          fi
          if ! (ninja -j $(sysctl -n hw.ncpu) 2>&1 | tee build.log); then
            echo "Build failed; dumping build log..."
            if [ -f build.log ]; then cat build.log; fi
            exit 1
          fi

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-macos
          path: |
            flare/build/cmake_configure.log
            flare/build/build.log
          if-no-files-found: ignore

      - name: Introduce Libraries and Stuff
        run: |
          cd flare/build/toonz
          # copy portable stuff if present
          cp -pr ../../../stuff Flare.app/portablestuff 2>/dev/null || true
          /usr/local/opt/qt@5/bin/macdeployqt Flare.app -verbose=0 -always-overwrite \
            -executable=Flare.app/Contents/MacOS/lzocompress \
            -executable=Flare.app/Contents/MacOS/lzodecompress \
            -executable=Flare.app/Contents/MacOS/tcleanup \
            -executable=Flare.app/Contents/MacOS/tcomposer \
            -executable=Flare.app/Contents/MacOS/tconverter \
            -executable=Flare.app/Contents/MacOS/tfarmcontroller \
            -executable=Flare.app/Contents/MacOS/tfarmserver

      - name: Modify Library Paths
        run: |
          cd flare/build/toonz/Flare.app/Contents/Frameworks
          for TARGETLIB in *.dylib; do
            otool -L "$TARGETLIB" | grep ".dylib" | grep -v "$TARGETLIB" | grep -v "@executable_path/../Frameworks" | awk '{print $1}' | while read -r FROMPATH; do
              LIBNAME=$(basename "$FROMPATH")
              if [[ -e ./$LIBNAME ]]; then
                install_name_tool -change "$FROMPATH" "@executable_path/../Frameworks/$LIBNAME" "$TARGETLIB"
              fi
            done
          done

      - name: Create Artifact
        run: |
          cd flare/build/toonz
          echo "Creating DMG..."
          ATTEMPT=0
          while [ $ATTEMPT -lt 10 ]; do
            /usr/local/opt/qt@5/bin/macdeployqt Flare.app -dmg -verbose=0 && \
            ([ -f Flare.dmg ] || [ -f toonz/Flare.dmg ]) && break
            ATTEMPT=$((ATTEMPT+1))
            echo "Attempt $ATTEMPT failed to build DMG."
          done
          if [ -f Flare.dmg ]; then
            echo "DMG=Flare.dmg" >> $GITHUB_ENV
          elif [ -f toonz/Flare.dmg ]; then
            echo "DMG=toonz/Flare.dmg" >> $GITHUB_ENV
          else
            echo "DMG=" >> $GITHUB_ENV
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: Flare-${{ runner.os }}-${{ github.sha }}
          path: flare/build/${{ env.DMG }}

      - name: Post build logs to PR
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && always() }}
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request ? context.payload.pull_request.number : undefined;
            if (!pr) { core.info('Not a pull_request event; skipping PR log posting.'); return; }
            function readTrunc(path) {
              try {
                if (!fs.existsSync(path)) return '(missing)';
                const content = fs.readFileSync(path, 'utf8');
                if (content.length > 12000) return content.slice(0, 6000) + '\n\n... (truncated) ...\n\n' + content.slice(-6000);
                return content;
              } catch (e) { return `(error reading ${path}): ${e.message}`; }
            }
            const cmake = readTrunc('flare/build/cmake_configure.log');
            const build = readTrunc('flare/build/build.log');
            const note = (!fs.existsSync('flare/build/cmake_configure.log') && !fs.existsSync('flare/build/build.log')) ? '\n\n**Note:** log files missing \u2013 checkout or prior step may have failed.' : '';
            const body = `**Automated build logs (truncated)**\n\n--- CMake configure log ---\n${cmake}\n\n--- Build log ---\n${build}${note}`;
            await github.rest.issues.createComment({ owner, repo, issue_number: pr, body });
