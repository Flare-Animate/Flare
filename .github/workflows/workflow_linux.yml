name: Linux Build

on:
  push:
    paths:
      - '**/*'
      - '!appveyor.yml'
      - '!README.md'
      - '!doc/**'
      - '!**/.github/**' # Simplificado
      - '.github/workflows/workflow_linux.yml'
  pull_request:
    paths:
      - '**/*'
      - '!appveyor.yml'
      - '!README.md'
      - '!doc/**'
      - '!.github/**' # Simplificado
      - '.github/workflows/workflow_linux.yml'

jobs:
  Ubuntu:
    runs-on: ubuntu-24.04
    timeout-minutes: 120 # Previene cancelación por tiempo
    strategy:
      fail-fast: false # Permite que si uno falla, el otro (gcc/clang) siga
      matrix:
        compiler: [gcc, clang]
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
          - compiler: clang
            cc: clang
            cxx: clang++

    steps:
    - uses: actions/checkout@v4 # Actualizado a v4 (más estable)
      with:
        lfs: true

    - name: Install libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential cmake pkg-config ninja-build ccache \
          libboost-all-dev qtbase5-dev qt5-qmake qtscript5-dev \
          qttools5-dev qttools5-dev-tools qtmultimedia5-dev qtwayland5 \
          libqt5svg5-dev libqt5opengl5-dev libqt5multimedia5-plugins \
          libqt5serialport5-dev libsuperlu-dev liblz4-dev libusb-1.0-0-dev \
          liblzo2-dev libpng-dev libjpeg-dev libglew-dev freeglut3-dev \
          libfreetype6-dev libjson-c-dev libmypaint-dev libopencv-dev \
          libturbojpeg0-dev libomp-dev libfuse2

    - name: Set up ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-${{ matrix.compiler }}
        max-size: "2G"

    - name: Build libtiff
      run: |
        cd thirdparty/tiff-4.0.3
        ./configure --disable-jbig --disable-shared --with-pic
        # Limitamos a 2 hilos para evitar que el OOM Killer cancele la operación
        make -j2 

    - name: Build OpenToonz
      run: |
        cd flare
        mkdir -p build && cd build
        set +e
        cmake ../sources -G Ninja \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
          -DCMAKE_C_COMPILER=${{ matrix.cc }} \
          -DWITH_TRANSLATION=OFF \
          -DCMAKE_BUILD_TYPE=Release > build/cmake_configure.log 2>&1
        rc=$?
        set -e
        echo "--- Begin CMake configure log ---"
        if [ -f build/cmake_configure.log ]; then cat build/cmake_configure.log; fi
        echo "--- End CMake configure log ---"
        if [ $rc -ne 0 ]; then echo "CMake configure failed with exit code $rc"; exit $rc; fi

        # Ninja por defecto usa todos los núcleos; aquí lo limitamos a 2
        ninja -j2 2>&1 | tee build/build.log

    - name: Upload build logs
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.compiler }}
        path: |
          flare/build/cmake_configure.log
          flare/build/build.log
        if-no-files-found: ignore

    - name: Create Artifact
      env:
        APPIMAGE_EXTRACT_AND_RUN: 1
      run: |
        cd flare/build
        sudo ninja install
        
        mkdir -p appdir/usr
        cp -r /opt/opentoonz/* appdir/usr
        # Evitar fallos si no existen iconos/desktops
        cp appdir/usr/share/applications/*.desktop appdir/ || true
        cp appdir/usr/share/icons/hicolor/256x256/apps/*.png appdir/ || true

        mkdir artifact
        if [ -d "appdir/usr/share/opentoonz/stuff" ]; then
          mv appdir/usr/share/opentoonz/stuff artifact/portablestuff
          rmdir appdir/usr/share/opentoonz || true
        fi

        # Descarga silenciosa y con reintentos
        base_url="https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous"
        for tool in linuxdeploy-x86_64.AppImage linuxdeploy-plugin-qt-x86_64.AppImage linuxdeploy-plugin-appimage-x86_64.AppImage; do
          wget -q --show-progress "${base_url}/${tool}" || \
          wget -q --show-progress "${base_url}/${tool}" || \
          wget -q --show-progress "${base_url}/${tool}"
          chmod +x "${tool}"
        done

        printf "#!/usr/bin/env bash\nexec \"\${APPDIR}/usr/bin/OpenToonz\"" > apprun.sh
        chmod 755 apprun.sh

        export LD_LIBRARY_PATH="appdir/usr/lib/opentoonz:$LD_LIBRARY_PATH"
        ./linuxdeploy-x86_64.AppImage --appdir=appdir --plugin=qt --output=appimage --custom-apprun=apprun.sh

        # Nombrado dinámico para evitar errores de archivo no encontrado
        mv OpenToonz*.AppImage artifact/OpenToonz.AppImage
        ARTIFACT_NAME=Opentoonz-${{ runner.os }}-${{ matrix.compiler }}
        mv artifact ${ARTIFACT_NAME}
        tar zcf ${ARTIFACT_NAME}.tar.gz ${ARTIFACT_NAME}

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: Opentoonz-AppImage-${{ matrix.compiler }}
        path: flare/build/*.tar.gz

