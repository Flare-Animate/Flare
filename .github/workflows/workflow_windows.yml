name: Windows Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  Windows:
    runs-on: windows-2022
    env:
      MSVCVERSION: "Visual Studio 17 2022"
      BOOST_TOOLSET: "14.3"
      BOOST_VERSION: "1.87.0"
      BOOST_ROOT: C:\local\boost_1_87_0
      OPENCV_VERSION: "4.11.0"
      OpenCV_DIR: C:\tools\opencv\build
      CCACHE_DIR: ${{ github.workspace }}\.ccache

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      # 1. Herramientas
      - name: Install Build Tools
        run: |
          choco install ccache -y
          ccache -M 2G
        shell: cmd

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      # 2. Librerías (Workaround LFS)
      - name: Download and Force Third-Party Libs
        run: |
          @echo on
          :: 1. Descarga (Mantenemos tu URL exacta)
          curl -fsSL -o libs.zip https://github.com/andeon/opentoonz-thirdparty-libs/releases/download/prebuilt-libs-v1/thirdparty-libs.zip
          
          :: 2. BORRADO PREVIO (Para eliminar los punteros corruptos de LFS)
          if exist thirdparty rmdir /S /Q thirdparty
          
          :: 3. Extraer (Ahora no hay nada que pisar, los archivos serán reales)
          7z x -y libs.zip -othirdparty
          
          :: 4. Configurar headers
          cd thirdparty
          
          copy /Y tiff-4.0.3\libtiff\tif_config.vc.h tiff-4.0.3\libtiff\tif_config.h
          copy /Y tiff-4.0.3\libtiff\tiffconf.vc.h tiff-4.0.3\libtiff\tiffconf.h
          copy /Y libpng-1.6.21\scripts\pnglibconf.h.prebuilt libpng-1.6.21\pnglibconf.h
          
          cd ..
          
          :: 5. Definir variable de entorno
          echo THIRDPARTY_DIR=%GITHUB_WORKSPACE%\thirdparty>> %GITHUB_ENV%
          del /Q libs.zip
        shell: cmd

      - name: Install custom Qt 5.15.2
        run: |
          @echo on
          if not exist thirdparty\qt mkdir thirdparty\qt
          curl -fsSL -o Qt5.15.2_wintab.zip https://github.com/shun-iwasawa/qt5/releases/download/v5.15.2_wintab/Qt5.15.2_wintab.zip
          
          :: Extraer el contenido
          7z x -y Qt5.15.2_wintab.zip -othirdparty\qt
          
          :: --- AUTODETECCIÓN DE RUTA ---
          :: Buscamos qmake.exe y subimos dos niveles para encontrar la raíz de Qt
          set "DETECTED_QT="
          for /f "delims=" %%i in ('dir /b /s "thirdparty\qt\qmake.exe"') do (
              set "QMAKE_PATH=%%~dpi"
          )
          
          :: Quitar la carpeta \bin\ de la ruta para tener la raíz de Qt
          if defined QMAKE_PATH (
              set "DETECTED_QT=%QMAKE_PATH:\bin\=%"
              echo Found Qt at: %DETECTED_QT%
          ) else (
              echo ERROR: qmake.exe not found!
              dir thirdparty\qt /s
              exit /b 1
          )

          :: Guardar en GITHUB_ENV sin espacios al final
          echo QT_PATH=%DETECTED_QT%>> %GITHUB_ENV%
        shell: cmd


      # 4. Gestión de Cachés (Separados para que ccache SIEMPRE guarde cambios)
      - name: Cache System Dependencies (OpenCV/Boost)
        id: build-cache
        uses: actions/cache@v4
        with:
          path: |
            C:\tools\opencv
            ${{ env.BOOST_ROOT }}
          key: ${{ runner.os }}-deps-${{ env.OPENCV_VERSION }}-${{ env.BOOST_VERSION }}

      - name: ccache storage
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-ccache-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Install OpenCV and Boost
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          choco install opencv --version=${{ env.OPENCV_VERSION }} -y
          choco install boost-msvc-14.3 --version=${{ env.BOOST_VERSION }} -y
        shell: cmd

      - name: Configure CMake
        run: |
          @echo on
          if exist build rmdir /S /Q build
          :: Aquí se "siembran" todas las configuraciones
          cmake -B build -G "%MSVCVERSION%" -A x64 ^
            -DQT_PATH="%QT_PATH%" ^
            -DBOOST_ROOT="%BOOST_ROOT%" ^
            -DOpenCV_DIR="%OpenCV_DIR%" ^
            -DTHIRDPARTY_DIR="%THIRDPARTY_DIR%" ^
            -DWITH_WINTAB=ON ^
            -DWITH_LZODRIVER=OFF ^
            -DCMAKE_C_COMPILER_LAUNCHER=ccache ^
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache ^
            -DCMAKE_BUILD_TYPE=RelWithDebInfo > build\cmake_configure.log 2>&1
          if %ERRORLEVEL% NEQ 0 (
            type build\cmake_configure.log
            exit /b %ERRORLEVEL%
          )
        shell: cmd

      - name: Archive build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-windows
          path: build\cmake_configure.log

      - name: Build Flare
        run: |
          cmake --build build --config RelWithDebInfo --parallel 4 > build\build.log 2>&1
          if %ERRORLEVEL% NEQ 0 (
            type build\cmake_configure.log
            type build\build.log
            exit /b %ERRORLEVEL%
          )

      # 7. Empaquetado
      - name: Create Package and Final Artifact
        run: |
          @echo on
          :: 1. Crear carpeta limpia
          if exist FlarePortable rmdir /S /Q FlarePortable
          mkdir FlarePortable

          :: 2. COPIAR EXE (Búsqueda global en build sin basura de CMake)
          for /f "delims=" %%i in ('dir /b /s "build\Flare.exe" ^| findstr /v "CMakeFiles"') do copy /Y "%%i" FlarePortable\Flare.exe
          
          :: 3. COPIAR DLLS (Corregido con la barra final FlarePortable\)
          for /f "delims=" %%d in ('dir /b /s "build\*.dll" ^| findstr /i "RelWithDebInfo" ^| findstr /v "CMakeFiles"') do copy /Y "%%d" FlarePortable\

          :: 4. VALIDACIÓN DE SEGURIDAD
          if not exist "FlarePortable\Flare.exe" (
              echo ERROR: No se encontro Flare.exe. Mostrando arbol de archivos:
              dir /s /b build | findstr /i ".exe"
              exit /b 1
          )

          :: 5. DEPENDENCIAS EXTERNAS (thirdparty y OpenCV)
          echo Copiando dependencias x64...
          for /f "delims=" %%l in ('dir /b /s "thirdparty\*.dll" ^| findstr /i "64 x64"') do copy /Y "%%l" FlarePortable\
          
          for /f "delims=" %%j in ('dir /b /s "C:\tools\opencv\*x64*\bin\opencv_world*.dll" 2^>nul') do copy /Y "%%j" FlarePortable\

          :: 6. DESPLEGAR QT + RUNTIME MSVC (msvcp140.dll, etc.)
          echo Ejecutando windeployqt...
          "%QT_PATH%\bin\windeployqt.exe" "FlarePortable\Flare.exe" --opengl --compiler-runtime

          :: 7. MODO PORTABLE (stuff -> portablestuff para los .ini)
          if exist "stuff" (
              mkdir "FlarePortable\portablestuff"
              xcopy /Y /E /I "stuff" "FlarePortable\portablestuff"
          )

          :: 8. LIMPIEZA FINAL
          del /S /Q FlarePortable\*.pdb 2>nul
        shell: cmd

      - name: Upload Flare Portable
        uses: actions/upload-artifact@v4
        with:
          name: Flare-Windows-Portable
          path: FlarePortable/
          if-no-files-found: error

