name: Windows Build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  Windows:
    runs-on: windows-2022
    env:
      MSVCVERSION: "Visual Studio 17 2022"
      BOOST_TOOLSET: "14.3"
      BOOST_VERSION: "1.87.0"
      BOOST_ROOT: C:\local\boost_1_87_0
      OPENCV_VERSION: "4.11.0"
      OpenCV_DIR: C:\tools\opencv\build
      CCACHE_DIR: ${{ github.workspace }}\.ccache

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      # 1. Herramientas
      - name: Install Build Tools
        run: |
          choco install ccache -y
          ccache -M 2G
        shell: cmd

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      # 2. Librerías (Workaround LFS)
      - name: Download and Force Third-Party Libs
        run: |
          @echo on
          :: 1. Descarga
          curl -fsSL -o libs.zip https://github.com/andeon/opentoonz-thirdparty-libs/releases/download/prebuilt-libs-v1/thirdparty-libs.zip
          
          :: 2. Extraer pisando lo que haya en la carpeta thirdparty del repo
          :: El flag -aoa de 7z sobreescribe todos los archivos existentes sin preguntar
          7z x -y libs.zip -othirdparty -aoa
          
          :: 3. Configurar headers
          cd thirdparty
          copy /Y tiff-4.0.3\libtiff\tif_config.vc.h tiff-4.0.3\libtiff\tif_config.h
          copy /Y tiff-4.0.3\libtiff\tiffconf.vc.h tiff-4.0.3\libtiff\tiffconf.h
          copy /Y libpng-1.6.21\scripts\pnglibconf.h.prebuilt libpng-1.6.21\pnglibconf.h
          cd ..
          
          :: 4. Definir variable de entorno para los siguientes pasos
          echo THIRDPARTY_DIR=%GITHUB_WORKSPACE%\thirdparty >> %GITHUB_ENV%
          del /Q libs.zip
        shell: cmd


      # 3. Qt Custom
      - name: Install custom Qt 5.15.2
        run: |
          @echo on
          if not exist thirdparty\qt mkdir thirdparty\qt
          :: RECUERDA poner tu URL completa aquí:
          curl -fsSL -o Qt5.15.2_wintab.zip https://github.com/shun-iwasawa/qt5/releases/download/v5.15.2_wintab/Qt5.15.2_wintab.zip
          7z x -y Qt5.15.2_wintab.zip -othirdparty\qt
          echo QT_PATH=%GITHUB_WORKSPACE%\thirdparty\qt\5.15.2_wintab\msvc2019_64 >> %GITHUB_ENV%
        shell: cmd

      # 4. Gestión de Cachés (Separados para que ccache SIEMPRE guarde cambios)
      - name: Cache System Dependencies (OpenCV/Boost)
        id: build-cache
        uses: actions/cache@v4
        with:
          path: |
            C:\tools\opencv
            ${{ env.BOOST_ROOT }}
          key: ${{ runner.os }}-deps-${{ env.OPENCV_VERSION }}-${{ env.BOOST_VERSION }}

      - name: ccache storage
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-ccache-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Install OpenCV and Boost
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          choco install opencv --version=${{ env.OPENCV_VERSION }} -y
          choco install boost-msvc-14.3 --version=${{ env.BOOST_VERSION }} -y
        shell: cmd

      # 5. Configurar CMake
      - name: Configure CMake
        run: |
          @echo on
          cd flare
          mkdir build && cd build
          :: Usamos la variable %THIRDPARTY_DIR% que definimos arriba en third party
          cmake .. -G "%MSVCVERSION%" -Ax64 ^
            -DQT_PATH="%QT_PATH%" ^
            -DBOOST_ROOT="%BOOST_ROOT%" ^
            -DOpenCV_DIR="%OpenCV_DIR%" ^
            -DTHIRDPARTY_DIR="%THIRDPARTY_DIR%" ^
            -DWITH_WINTAB=ON ^
            -DCMAKE_C_COMPILER_LAUNCHER=ccache ^
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        shell: cmd

      # 6. Compilación
      - name: Build Opentoonz
        run: |
          @echo on
          cd flare\build
          msbuild "ALL_BUILD.vcxproj" /p:Configuration=RelWithDebInfo /m /verbosity:minimal
          ccache -s
        shell: cmd

      # 7. Empaquetado
      - name: Create Package
        run: |
          @echo on
          cd flare\build
          set "CONF=RelWithDebInfo"
          if exist Opentoonz rmdir /S /Q Opentoonz
          mkdir Opentoonz
          copy /Y "%CONF%\*.*" Opentoonz\
          
          if exist "..\..\thirdparty\glut\3.7.6\lib\glut64.dll" copy /Y "..\..\thirdparty\glut\3.7.6\lib\glut64.dll" Opentoonz\
          if exist "..\..\thirdparty\glew\glew-1.9.0\bin\64bit\glew32.dll" copy /Y "..\..\thirdparty\glew\glew-1.9.0\bin\64bit\glew32.dll" Opentoonz\
          if exist "..\..\thirdparty\libmypaint\dist\64" xcopy /Y /E "..\..\thirdparty\libmypaint\dist\64\*.dll" Opentoonz\
          
          copy /Y "C:\tools\opencv\build\x64\vc16\bin\opencv_world4110.dll" Opentoonz\
          "%QT_PATH%\bin\windeployqt.exe" Opentoonz\Opentoonz.exe --opengl
          
          if exist "..\..\stuff" xcopy /Y /E /I "..\..\stuff" "Opentoonz\portablestuff"
          
          del /Q Opentoonz\*.pdb
        shell: cmd

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Opentoonz-Win-Portable
          path: flare/build/Opentoonz/


